#!/usr/bin/env ruby

require 'json'
require 'time'

package_file_path = File.join(File.dirname(__FILE__), '..', 'package.json')
package_file = File.read(package_file_path)
package = JSON.parse(package_file)

begin
  build_config_file_path = File.join(File.dirname(__FILE__), '..', 'build-config.json')
  build_config_file = File.read(build_config_file_path)
  build_config = JSON.parse(build_config_file)
rescue JSON::ParserError
  error_message = "An error occured while parsing the build config. Hint: if you're setting it's value by a environment variable, you should put single quotes around it. E.g. `BUILD_CONFIG='{\"key\":\"value\"}'`"
  puts "Error: #{error_message}"
  raise error_message
end

bundle_name = build_config['bundleName']
bundle_identifier = build_config['ios']['bundleIdentifier']
bundle_display_name = build_config['displayName']

itc_team_id = build_config['ios']['itcTeamId']
team_id = build_config['ios']['teamId']

provisioning_profile_id = build_config['ios']['provisioningProfileId']
provisioning_profile_specifier = build_config['ios']['provisioningProfileSpecifier']

version = package['version']
version_date_string = package['versionDate']
bundle_version = Dir.chdir(File.dirname(__FILE__)) { `./cfbundleversion-from-git-hash-and-date "$(git rev-parse --short=7 HEAD)" #{version_date_string}` }

print <<-EOF
//
//  Config.xcconfig
//  XConf
//
//  This is a file generated by the generate-ios-config script.
//  DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN.
//

BUNDLE_NAME = #{bundle_name}
BUNDLE_IDENTIFIER = #{bundle_identifier}
BUNDLE_DISPLAY_NAME = #{bundle_display_name}
BUNDLE_SHORT_VERSION_STRING = #{version}
BUNDLE_VERSION = #{bundle_version}
ITC_TEAM_ID = #{itc_team_id}
TEAM_ID = #{team_id}
PROVISIONING_PROFILE_ID = #{provisioning_profile_id}
PROVISIONING_PROFILE_SPECIFIER = #{provisioning_profile_specifier}
EOF
